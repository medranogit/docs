---
title: "global.lua"
description: "Documenta√ß√£o t√©cnica de global.lua"
icon: "file-code"
---

<img
  style={{ borderRadius:"0.5rem" }}
  src="/images/hero-dark.png"
/>

## üõ†Ô∏è Informa√ß√µes do Arquivo

Este arquivo √© respons√°vel por estabelecer o ambiente base do servidor Lua. Ele define constantes universais (como dire√ß√µes, estados de PVP), inicializa tabelas globais para sistemas complexos e carrega bibliotecas essenciais.

<ResponseField name="Caminho Original" type="path">
  `server/data/global.lua`
</ResponseField>

<Tip>
  Este arquivo foi mapeado automaticamente. Altera√ß√µes aqui afetam o servidor globalmente. Cuidado ao modificar constantes de sistema como `DIRECTIONS_TABLE` ou `AUTH_TYPE`.
</Tip>

## üìÑ Vis√£o Geral do C√≥digo

### Resumo Executivo

O `global.lua` atua como a espinha dorsal da configura√ß√£o em tempo de execu√ß√£o. Ele traduz configura√ß√µes do `config.lua` (via `configManager`) para vari√°veis Lua globais e define a l√≥gica de sistemas transversais, como a regenera√ß√£o de Stamina em trainers e zonas de prote√ß√£o.

### üìç Fluxo de Carregamento

Entender a ordem de carregamento √© crucial para saber quais vari√°veis est√£o dispon√≠veis em cada etapa.

1. **Quem carrega este arquivo?**
   - Ele √© executado pelo `server/data/core.lua` atrav√©s da fun√ß√£o `dofile`.
   - Isso ocorre logo no in√≠cio da inicializa√ß√£o do datapack.
2. **Quem este arquivo carrega?**
   - `server/data/lib/lib.lua`: Carrega a biblioteca principal de fun√ß√µes auxiliares.
   - `server/data/startup/startup.lua`: Executa scripts de inicializa√ß√£o √∫nica (se o arquivo existir).

```mermaid
graph LR
    A[core.lua] -->|dofile| B(global.lua)
    B -->|dofile| C[lib/lib.lua]
    B -->|check & dofile| D[startup/startup.lua]
```

### An√°lise de Fun√ß√µes Principais

#### 1. `addStamina`

Gerencia a regenera√ß√£o de stamina do jogador em duas situa√ß√µes: treinando em "Exercise Dummies" ou descansando em Zona de Prote√ß√£o (PZ).

- **Par√¢metros:**
  - `playerId` (Number | UserData): O ID ou objeto do jogador.
  - `...` (Varargs): Argumentos vari√°veis dependendo do contexto (delay, localPlayerId).
- **L√≥gica Interna:**
  - **Modo Trainer:** Verifica se o jogador est√° atacando o alvo correto ("Training Machine"). Se sim, adiciona stamina periodicamente e agenda o pr√≥ximo evento recursivamente.
  - **Modo PZ:** Verifica se o jogador est√° em PZ. Se a stamina estiver na "Green Stamina" (40h-42h), o delay de regenera√ß√£o √© ajustado.
- **Retorno:** `true` se o evento foi agendado com sucesso, `false` caso contr√°rio.

#### 2. `IsRetroPVP` / `IsTravelFree`

Wrappers (envolt√≥rios) simples para verificar configura√ß√µes do `config.lua`.

- **Prop√≥sito:** Facilitar a leitura do c√≥digo em outros scripts, evitando chamadas longas ao `configManager`.
- **Retorno:** Boolean (`true` ou `false`).

### Estruturas de Dados Globais

O arquivo inicializa tabelas vazias para garantir que sistemas em outros arquivos n√£o encontrem valores `nil`.

- `_G.GlobalBosses`: Armazena estado de bosses globais.
- `_G.OnExerciseTraining`: Controla jogadores treinando.
- `ropeSpots` / `specialRopeSpots`: Lista de IDs de itens onde a corda pode ser usada.
- `swimmingTiles`: Lista de IDs de tiles onde o personagem muda para a outfit de nata√ß√£o.

### Exemplo de Uso

Como as vari√°veis definidas aqui s√£o globais, voc√™ pode acess√°-las em qualquer script (Actions, Movements, Globalevents) sem precisar de `require`.

```lua
-- Exemplo em um script de action qualquer
function onUse(player, item, fromPosition, target, toPosition, isHotkey)
    -- Usando uma constante definida no global.lua
    if PARTY_PROTECTION == 0 then
        player:sendTextMessage(MESSAGE_STATUS_CONSOLE_BLUE, "Cuidado! Party Protection est√° DESATIVADO.")
    end

    -- Verificando se um tile √© de nata√ß√£o usando a tabela global
    if table.contains(swimmingTiles, item.itemid) then
        player:sendTextMessage(MESSAGE_INFO_DESCR, "Voc√™ pode nadar aqui!")
    end
    return true
end
```

### Observa√ß√µes T√©cnicas

- **Depend√™ncia do ConfigManager:** Muitas constantes (`SERVER_NAME`, `AUTH_TYPE`) dependem diretamente de valores carregados do C++ via `configManager`. Se o `config.lua` estiver mal configurado, este arquivo pode gerar erros ou comportamentos inesperados.
- **`Extens√£o de table:`** O arquivo injeta a fun√ß√£o `table.contains` na biblioteca padr√£o `table` do Lua. Isso √© √∫til, mas deve-se ter cuidado ao atualizar a vers√£o do Lua ou do servidor para n√£o haver conflitos de nomes.

### Alertas

<Warning>
  **Modifica√ß√£o de Constantes:** Alterar valores como `NORTH`, `SOUTH` ou `DIRECTIONS_TABLE` quebrar√° a l√≥gica de movimenta√ß√£o e verifica√ß√£o de dire√ß√£o de todo o servidor.
</Warning>

<Warning>
  **Stamina Logic:** A fun√ß√£o `addStamina` cont√©m "n√∫meros m√°gicos" (ex: `2520` para stamina cheia, `2340` para in√≠cio da green stamina). Ao alterar as taxas de stamina no C++, lembre-se de atualizar esta l√≥gica aqui para refletir os novos limites.
</Warning>

```lua global.lua
-- Trecho visual da l√≥gica de Stamina
function addStamina(playerId, ...)
    -- ...
    local actualStamina = player:getStamina()
    if actualStamina > 2340 and actualStamina < 2520 then
        -- L√≥gica espec√≠fica para Green Stamina
        delay = configManager.getNumber(configKeys.STAMINA_GREEN_DELAY) * 60 * 1000
    end
    -- ...
end
```