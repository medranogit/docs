---
title: "core.lua"
description: "Documenta√ß√£o t√©cnica de core.lua"
icon: "file-code"
---

## üõ†Ô∏è Informa√ß√µes do Arquivo

Este arquivo atua como o inicializador central do ambiente Lua do servidor (OTServ), respons√°vel por definir os caminhos dos diret√≥rios principais e carregar os m√≥dulos essenciais em sequ√™ncia. √â a espinha dorsal que conecta as configura√ß√µes globais, bibliotecas e regras de progress√£o (stages) ao motor do jogo.

<ResponseField name="Caminho Original" type="path">
  `server/data/core.lua`
</ResponseField>

<Tip>
  Este arquivo √© um ponto de entrada cr√≠tico. A ordem das chamadas `dofile` aqui estabelece a hierarquia de depend√™ncias para todos os outros scripts do servidor.
</Tip>

## üìÑ Vis√£o Geral do C√≥digo

### Resumo Executivo

O `core.lua` inicializa o ambiente de script recuperando configura√ß√µes de diret√≥rio do motor C++ e carregando arquivos Lua fundamentais. Sua import√¢ncia √© vital, pois garante que vari√°veis globais, bibliotecas e configura√ß√µes de experi√™ncia estejam dispon√≠veis antes que qualquer sistema de jogo seja ativado.

### Fluxo de Execu√ß√£o

Este arquivo √© executado pelo motor do servidor durante a fase de inicializa√ß√£o (startup). Ele orquestra o carregamento de outros componentes vitais.

```mermaid
graph LR
    A[Engine C++] -->|Inicializa| B[core.lua]
    B -->|Get Config| C{configManager}
    B -->|dofile| D[global.lua]
    B -->|dofile| E[libs/libs.lua]
    B -->|dofile| F[stages.lua]
    
    D -.->|Define| G[Vari√°veis Globais]
    E -.->|Carrega| H[Bibliotecas Auxiliares]
    F -.->|Configura| I[Experience/Skill Stages]
```

### An√°lise de L√≥gica do Script

Como este arquivo √© um script de execu√ß√£o linear e n√£o uma cole√ß√£o de fun√ß√µes, a an√°lise foca nas opera√ß√µes realizadas linha a linha:

1. **Defini√ß√£o de Diret√≥rios Base**:
   - **Opera√ß√£o**: `configManager.getString(configKeys.DATA_DIRECTORY)` e `CORE_DIRECTORY`.
   - **Prop√≥sito**: Estabelece as vari√°veis globais `DATA_DIRECTORY` e `CORE_DIRECTORY` que ser√£o usadas por outros scripts para localizar arquivos.
   - **L√≥gica**: Busca os valores definidos no `config.lua` (ou equivalente em C++) atrav√©s da interface `configManager`.
2. **Carregamento do Ambiente Global**:
   - **Opera√ß√£o**: `dofile(CORE_DIRECTORY .. "/global.lua")`.
   - **Prop√≥sito**: Executa o arquivo `global.lua`.
   - **Impacto**: Disponibiliza constantes, fun√ß√µes utilit√°rias globais e configura√ß√µes de servidor (como `SERVER_NAME`, `IsRetroPVP`) para todo o sistema.
3. **Carregamento de Bibliotecas**:
   - **Opera√ß√£o**: `dofile(CORE_DIRECTORY .. "/libs/libs.lua")`.
   - **Prop√≥sito**: Carrega fun√ß√µes auxiliares e bibliotecas estendidas.
4. **Carregamento de Est√°gios (Stages)**:
   - **Opera√ß√£o**: `dofile(CORE_DIRECTORY .. "/stages.lua")`.
   - **Prop√≥sito**: Define as tabelas de experi√™ncia, skills e magic level.
   - **Impacto**: Configura a curva de progress√£o do jogo (ex: `experienceStages`).

### Exemplo de Uso

Este arquivo n√£o √© "chamado" por outros scripts Lua, mas sim executado automaticamente. Abaixo est√° o conte√∫do t√≠pico e como ele estrutura o carregamento:

```lua core.lua
-- Implementa√ß√£o t√©cnica de: core.lua
-- Localiza√ß√£o: server/data/core.lua

-- 1. Recupera caminhos configurados no config.lua
DATA_DIRECTORY = configManager.getString(configKeys.DATA_DIRECTORY)
CORE_DIRECTORY = configManager.getString(configKeys.CORE_DIRECTORY)

-- 2. Carrega o ambiente global (vari√°veis, constantes, eventos globais b√°sicos)
dofile(CORE_DIRECTORY .. "/global.lua")

-- 3. Carrega bibliotecas de fun√ß√µes (libs)
dofile(CORE_DIRECTORY .. "/libs/libs.lua")

-- 4. Carrega configura√ß√µes de est√°gios de experi√™ncia e skills
dofile(CORE_DIRECTORY .. "/stages.lua")
```

### Observa√ß√µes T√©cnicas

- **Depend√™ncias de C++**: O script depende estritamente que o objeto `configManager` e o enum `configKeys` j√° estejam expostos pelo motor do servidor (Source Code) antes da execu√ß√£o deste arquivo.
- **Sistema de Arquivos**: Utiliza caminhos absolutos ou relativos baseados na configura√ß√£o do servidor. Se `CORE_DIRECTORY` estiver configurado incorretamente no `config.lua`, o servidor falhar√° ao iniciar (crash) pois n√£o encontrar√° os arquivos subsequentes.
- **Ordem de Execu√ß√£o**: A ordem √© intencional. `global.lua` deve vir primeiro para que `libs.lua` ou `stages.lua` possam usar vari√°veis globais se necess√°rio (embora `stages.lua` seja geralmente independente).

### Alertas

- ‚ö†Ô∏è **Caminhos Incorretos**: Alterar a estrutura de pastas do servidor sem atualizar as chaves `DATA_DIRECTORY` ou `CORE_DIRECTORY` no `config.lua` quebrar√° este script imediatamente.
- ‚ö†Ô∏è **Depend√™ncia Circular**: Evite adicionar `dofile` neste arquivo que aponte para scripts que tentem carregar o `core.lua` novamente.
- ‚ö†Ô∏è **Falha Cr√≠tica**: Se qualquer um dos arquivos referenciados (`global.lua`, `libs.lua`, `stages.lua`) contiver erros de sintaxe, o carregamento do servidor ser√° abortado neste ponto.