---
title: "npc.lua"
description: "Documenta√ß√£o t√©cnica de npc.lua"
icon: "file-code"
---

<img
  style={{ borderRadius:"0.5rem" }}
  src="/images/hero-dark.png"
/>

## üõ†Ô∏è Informa√ß√µes do Arquivo

Este arquivo estende a classe `Npc` (do motor C++) com fun√ß√µes auxiliares escritas em Lua. Ele tamb√©m define fun√ß√µes globais cr√≠ticas para o reconhecimento de texto (como `MsgContains`), que s√£o usadas para detectar se um jogador disse uma palavra-chave espec√≠fica.

<ResponseField name="Caminho Original" type="path">
  `server/data/npclib/npc.lua`
</ResponseField>

<Tip>
  A fun√ß√£o `MsgContains` definida aqui √© a base de toda a intera√ß√£o de chat dos NPCs. Ela garante que "hi" seja detectado em "hi there", mas evita falsos positivos comuns.
</Tip>

## üìÑ Vis√£o Geral do C√≥digo

### Resumo Executivo

O `npc.lua` serve como uma camada de utilit√°rios sobre o objeto NPC padr√£o. Ele implementa l√≥gica para filas de mensagens com atraso (`sayWithDelay`), formata√ß√£o de listas de compras e fun√ß√µes de compara√ß√£o de strings que ignoram mai√∫sculas/min√∫sculas para facilitar a cria√ß√£o de scripts de di√°logo.

### Fluxo de Execu√ß√£o

Este arquivo √© carregado pelo `load.lua` e suas fun√ß√µes tornam-se dispon√≠veis globalmente ou como m√©todos de qualquer objeto `Npc`.

```mermaid
graph TD
    A[load.lua] -->|dofile| B[npc.lua]
    B -.->|Define Global| C[MsgContains / MsgFind]
    B -.->|Define Global| D[SayEvent]
    B -.->|Estende| E[Npc:sayWithDelay]
    B -.->|Estende| F[Npc:talk]
    
    G[Script de NPC] -->|Usa| C
    G -->|Chama| F
```

### An√°lise de Fun√ß√µes Globais

Estas fun√ß√µes podem ser chamadas de qualquer lugar no c√≥digo Lua do servidor.

#### `MsgContains(message, keyword)`

Verifica se uma mensagem cont√©m uma palavra-chave, ignorando mai√∫sculas/min√∫sculas.

```lua
function MsgContains(message, keyword)
	local lowerMessage, lowerKeyword = message:lower(), keyword:lower()
	if lowerMessage == lowerKeyword then
		return true
	end

	return lowerMessage:find(lowerKeyword) and not lowerMessage:find("(%w+)" .. lowerKeyword)
end
```

- **Par√¢metros**:
  - `message`: A frase completa dita pelo jogador.
  - `keyword`: A palavra que se deseja encontrar.
- **L√≥gica**: Converte ambas para min√∫sculo. Retorna `true` se forem iguais OU se a `keyword` estiver na mensagem mas **n√£o** for precedida por letras/n√∫meros.
  - _Comportamento_: Evita que "sushi" ative a palavra "hi" (pois 's' precede 'hi'). Por√©m, permite que "hire" ative "hi" (pois nada precede 'hi').
- **Retorno**: `boolean`.

#### `MsgFind(message, keyword)`

Uma varia√ß√£o de busca de string com l√≥gica espec√≠fica.

```lua lines wrap
function MsgFind(message, keyword)
	local lowerMessage, lowerKeyword = message:lower(), keyword:lower()
	if lowerMessage == lowerKeyword then
		return true
	end

	return string.find(lowerMessage, lowerKeyword) and string.find(lowerMessage, lowerKeyword .. "(%w+)") and string.find(lowerMessage, "(%w+)" .. lowerKeyword)
end
```

- **L√≥gica**: Verifica se a `keyword` est√° contida na `message` E se est√° cercada por caracteres alfanum√©ricos (`%w+`) em ambos os lados.
  - _Nota_: Esta fun√ß√£o verifica se a palavra est√° _embutida_ dentro de outra (ex: "test" dentro de "attesting"). O uso √© raro.
- **Retorno**: `boolean`.

#### `GetFormattedShopCategoryNames(itemsTable)`

Formata uma tabela de categorias de loja em uma string leg√≠vel.

```lua lines wrap
function GetFormattedShopCategoryNames(itemsTable)
	local formattedCategoryNames = {}
	for categoryName, _ in pairs(itemsTable) do
		table.insert(formattedCategoryNames, "{" .. categoryName .. "}")
	end

	if #formattedCategoryNames > 1 then
		local lastCategory = table.remove(formattedCategoryNames)
		return table.concat(formattedCategoryNames, ", ") .. " and " .. lastCategory
	else
		return formattedCategoryNames[1] or ""
	end
end
```

- **Par√¢metros**: `itemsTable` (tabela onde as chaves s√£o nomes de categorias).
- **Retorno**: String formatada (ex: "Swords, Axes and Clubs").
- **L√≥gica**: Itera sobre as chaves, adiciona chaves `{}` e une com v√≠rgulas e um "and" final.

#### `GetCount(string)`

Extrai o primeiro n√∫mero encontrado em uma string.

- **Uso**: √ötil para saber quantidades quando o jogador diz "buy 50 potions".
- **Retorno**: `number` (o valor encontrado) ou `-1` se n√£o achar nada.

#### `SayEvent(npcId, playerId, messageDelayed, npcHandler, textType)`

A fun√ß√£o de callback executada quando um NPC fala com atraso (delay).

- **Prop√≥sito**: Processar tags din√¢micas na mensagem antes de envi√°-la.
- **Tags Processadas**:
  - `|PLAYERNAME|`: Nome do jogador.
  - `|TIME|`: Hora do jogo formatada.
  - `|BLESSCOST|`: Custo de blessings. **Nota:** Cont√©m l√≥gica hardcoded verificando se o NPC se chama "Kais" ou "Nomad" para ajustar o pre√ßo.
  - `|PVPBLESSCOST|`: Custo da Twist of Fate.
- **L√≥gica**: Valida se NPC e Player ainda existem, faz o parse das tags e chama `npc:say`.

---

### An√°lise de M√©todos da Classe NPC

Estas fun√ß√µes estendem a metatabela `Npc`, permitindo chamadas como `npc:funcao()`.

#### `Npc:talk(player, text)`

Envia uma ou mais mensagens para um jogador espec√≠fico.

<Frame>
  ![Image](/images/image-2.png)
</Frame>

- **Par√¢metros**:
  - `player`: Objeto Player.
  - `text`: String √∫nica ou Tabela de strings.
- **L√≥gica**: Se `text` for tabela, itera e envia cada linha. Internamente chama `self:sendMessage`.

#### `Npc:sendMessage(player, text)`

Envia uma mensagem privada (NPC Channel) formatando o nome do jogador.

<Frame>
  ![Image](/images/image.png)
</Frame>

- **L√≥gica**: Usa `string.format` para injetar o nome do jogador caso o texto contenha `%s`. Define o tipo de fala como `TALKTYPE_PRIVATE_NP`.

#### `Npc:sayWithDelay(npcId, text, messageType, delay, eventDelay, player)`

Agenda uma fala do NPC para o futuro.

- **Par√¢metros**:
  - `eventDelay`: Uma tabela que armazena o ID do evento (para poder cancelar se o jogador andar).
- **L√≥gica**: Usa `addEvent` chamando a fun√ß√£o local `sayFunction`.

#### `Npc:getRemainingShopCategories(selectedCategory, itemsTable)`

Retorna uma string com todas as categorias da loja, exceto a selecionada.

```lua
function Npc:getRemainingShopCategories(selectedCategory, itemsTable)
	local remainingCategories = {}
	for categoryName, _ in pairs(itemsTable) do
		if categoryName ~= selectedCategory then
			table.insert(remainingCategories, "{" .. categoryName .. "}")
		end
	end
	return table.concat(remainingCategories, " or ")
end
```

- **Uso**: Para di√°logos como "Al√©m de espadas, eu tamb√©m vendo Machados ou Clavas".

---

### Fun√ß√µes Locais

#### `sayFunction(npcId, text, type, eventDelay, playerId)`

Callback simples usado pelo `Npc:sayWithDelay`.

- **Prop√≥sito**: Executar a fala agendada e marcar o evento como conclu√≠do (`eventDelay.done = true`).

### Exemplo de Uso

Exemplo de como essas fun√ß√µes interagem em um script de NPC:

```lua
-- Exemplo em um script de NPC
local mensagem = "Hello there traveler"

-- Verifica se a mensagem cont√©m "hello"
if MsgContains(mensagem, "hello") then
    -- O NPC responde com duas mensagens
    npc:talk(player, {"Greetings!", "How can I help you today?"})
end

-- Exemplo de extra√ß√£o de quantidade
local playerMsg = "I want 100 gold"
local count = GetCount(playerMsg) -- Retorna 100
```

### Observa√ß√µes T√©cnicas

- **Extens√£o de Metatabela**: O c√≥digo adiciona fun√ß√µes diretamente √† tabela `Npc` (que representa a classe userdata do C++), permitindo a sintaxe orientada a objetos `npc:funcao()`.
- **Regras de Neg√≥cio Hardcoded**: A fun√ß√£o `SayEvent` cont√©m l√≥gica espec√≠fica para os NPCs **Kais** e **Nomad** (`npc:getName() == "Kais"`), alterando o c√°lculo do custo da blessing. Isso cria um acoplamento forte entre a biblioteca e esses NPCs espec√≠ficos.
- **Regex Manual**: As fun√ß√µes `MsgContains` e `MsgFind` evitam o uso de bibliotecas de regex pesadas, optando por manipula√ß√£o de string nativa do Lua (`string.find`), o que √© bom para performance.

### Alertas

- ‚ö†Ô∏è **Performance**: `MsgContains` faz opera√ß√µes de string (`lower`, `find`) a cada mensagem recebida por qualquer NPC. √â eficiente, mas scripts que abusam de regex complexos aqui podem causar impacto.
- ‚ö†Ô∏è **Eventos Pendentes**: O sistema de delay armazena eventos. Se um NPC for removido ou o servidor reiniciar, esses eventos pendentes s√£o perdidos.
- ‚ö†Ô∏è **MsgFind vs MsgContains**: A fun√ß√£o `MsgFind` tem uma l√≥gica muito espec√≠fica (exige caracteres alfanum√©ricos antes E depois). Para a maioria dos casos de detec√ß√£o de palavras, use `MsgContains`.